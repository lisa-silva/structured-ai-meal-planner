<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structured Meal Planner AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#f97316',
                        'bg-light': '#fefefe',
                        'bg-dark': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom scrollbar for generated content */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-bg-dark min-h-screen p-4 sm:p-8 font-sans">

    <!-- Main Container -->
    <div id="app" class="max-w-4xl mx-auto">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-primary mb-2">
                Structured Meal Planner AI
            </h1>
            <p class="text-lg text-gray-600">
                Generate custom, structured meal plans using Gemini AI.
            </p>
        </header>

        <!-- Input Card -->
        <div class="bg-bg-light p-6 sm:p-8 rounded-2xl shadow-custom mb-8 border-t-4 border-secondary">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Meal Goals & Constraints</h2>

            <div class="space-y-4">
                <!-- User Prompt Input -->
                <textarea id="userPrompt" rows="4"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out resize-none text-gray-700"
                    placeholder="E.g., 7-day plan, 1800 calories/day, low-carb, I hate mushrooms, focus on chicken and fish. Specify number of days, dietary restrictions, calorie goals, and preferences/dislikes."
                >7-day meal plan for a 2000 calorie-per-day diet. Must be high protein and low dairy. I enjoy cooking and want dinner recipes that take less than 45 minutes.</textarea>
                
                <!-- System Instruction Input -->
                <textarea id="systemInstruction" rows="2"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out resize-none text-gray-700 bg-gray-50"
                    placeholder="AI Persona (Optional): E.g., Act as a Michelin-star chef."
                >Act as a friendly, highly-organized nutritionist specializing in balanced, high-protein diets.</textarea>

                <!-- API Key Input -->
                <input type="password" id="apiKey"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out text-gray-700"
                    placeholder="Enter your Gemini API Key (required)"
                >
            </div>

            <!-- Generate Button -->
            <button id="generateButton"
                class="mt-6 w-full py-3 px-4 bg-primary text-white font-bold text-lg rounded-xl hover:bg-indigo-600 transition duration-150 ease-in-out disabled:opacity-50 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300"
                onclick="generateMealPlan()"
            >
                Generate Meal Plan
            </button>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden mt-4 text-center">
                <div class="inline-block w-8 h-8 border-4 border-primary border-t-transparent border-solid rounded-full animate-spin-slow" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="text-primary mt-2 font-medium">Generating your plan...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg font-medium">
                <!-- Error content here -->
            </div>
        </div>

        <!-- Output Card -->
        <div id="outputCard" class="bg-bg-light p-6 sm:p-8 rounded-2xl shadow-custom border-t-4 border-primary">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center justify-between">
                Generated Meal Plan
                <button id="copyButton" 
                        class="text-sm px-3 py-1 bg-secondary text-white rounded-full hover:bg-orange-600 transition duration-150 disabled:opacity-50" 
                        onclick="copyContent()" disabled>
                    Copy Plan
                </button>
            </h2>
            
            <div id="mealPlanOutput" class="min-h-[200px] bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-700 whitespace-pre-wrap custom-scrollbar overflow-y-auto">
                Your structured meal plan will appear here. Enter your API key and preferences above to begin!
            </div>
            
            <!-- Citation Sources -->
            <div id="sourcesContainer" class="mt-4 hidden">
                <h3 class="text-sm font-semibold text-gray-600 mb-1">Sources Used:</h3>
                <ul id="sourcesList" class="list-disc list-inside text-xs text-gray-500 space-y-1">
                    <!-- Sources will be injected here -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // NOTE: __api_key is only available in the canvas environment. On a live site, it must be provided by the user via the input field.
        const initialApiKey = typeof __api_key !== 'undefined' ? __api_key : '';

        document.addEventListener('DOMContentLoaded', () => {
            const apiKeyInput = document.getElementById('apiKey');
            if (initialApiKey) {
                apiKeyInput.value = initialApiKey;
                apiKeyInput.disabled = true; // Disable input if key is pre-filled
                apiKeyInput.placeholder = 'API Key provided by environment';
            }
        });

        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isError 
                ? 'mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg font-medium' 
                : 'mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg font-medium';
            element.style.display = 'block';
        }

        function hideMessage(elementId) {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function toggleLoading(isLoading) {
            document.getElementById('loadingIndicator').style.display = isLoading ? 'block' : 'none';
            document.getElementById('generateButton').disabled = isLoading;
            document.getElementById('copyButton').disabled = isLoading || !document.getElementById('mealPlanOutput').textContent.trim() || document.getElementById('mealPlanOutput').textContent.includes('Your structured meal plan will appear here');
        }

        async function generateMealPlan() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const userPrompt = document.getElementById('userPrompt').value.trim();
            const systemInstruction = document.getElementById('systemInstruction').value.trim();
            const outputDiv = document.getElementById('mealPlanOutput');
            const errorMessageDiv = document.getElementById('errorMessage');
            const sourcesContainer = document.getElementById('sourcesContainer');
            const sourcesList = document.getElementById('sourcesList');

            hideMessage('errorMessage');
            outputDiv.textContent = '';
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';

            if (!apiKey) {
                showMessage('errorMessage', 'Please enter your Gemini API Key.', true);
                return;
            }
            if (!userPrompt) {
                showMessage('errorMessage', 'Please enter your meal goals and constraints.', true);
                return;
            }

            toggleLoading(true);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = systemInstruction || "You are an expert, highly-structured meal planning assistant.";
            
            const fullUserQuery = `Using your knowledge and real-world data (if necessary, use Google Search for current information or specific recipe ideas), generate a structured, easy-to-read meal plan. 

- **Format:** The response must be pure Markdown text (do not use JSON). Use bold text for days and meal names.
- **Content Goal:** Fulfill the following user request exactly: "${userPrompt}"
- **Structure:** Provide a structured plan with days, and within each day, list Breakfast, Lunch, and Dinner. For dinner, include a brief description or an estimated cooking time (e.g., 'Chicken Stir-fry (35 mins)').
- **Tones/Rules:** ${systemPrompt}`;

            const payload = {
                contents: [{ parts: [{ text: fullUserQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 5;
            let lastError = null;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Request failed with status ${response.status}: ${JSON.stringify(errorData)}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        outputDiv.textContent = text;
                        
                        // Extract grounding sources
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        // Display sources
                        if (sources.length > 0) {
                            sourcesList.innerHTML = '';
                            sources.forEach(source => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.href = source.uri;
                                a.target = '_blank';
                                a.rel = 'noopener noreferrer';
                                a.textContent = `${source.title} (${new URL(source.uri).hostname})`;
                                a.className = 'text-primary hover:underline';
                                li.appendChild(a);
                                sourcesList.appendChild(li);
                            });
                            sourcesContainer.classList.remove('hidden');
                        } else {
                             sourcesContainer.classList.add('hidden');
                        }
                        
                        toggleLoading(false);
                        return; // Success, exit function
                    } else {
                        throw new Error("Received an empty or malformed response from the model.");
                    }

                } catch (error) {
                    lastError = error;
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    // Implement exponential backoff
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // If all retries fail
            toggleLoading(false);
            showMessage('errorMessage', `Failed to generate meal plan after multiple retries. Please check your API key, network connection, or try simplifying your prompt. Details: ${lastError ? lastError.message : 'Unknown error.'}`, true);
        }

        function copyContent() {
            const content = document.getElementById('mealPlanOutput').textContent;
            
            // Fallback for secure copy in iFrames (like this environment)
            const textarea = document.createElement('textarea');
            textarea.value = content;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                document.getElementById('copyButton').textContent = 'Copied!';
                setTimeout(() => {
                    document.getElementById('copyButton').textContent = 'Copy Plan';
                }, 2000);
            } catch (err) {
                console.error('Could not copy text: ', err);
                document.getElementById('copyButton').textContent = 'Copy Failed';
            }
            
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>
Gross
